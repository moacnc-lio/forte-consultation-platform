#!/usr/bin/env python3
"""
2025년 최신 연구 기반 나머지 14개 시술 정보 업데이트 스크립트
인터넷 리서치를 통해 수집된 데이터를 기반으로 업데이트
"""

import os
import sys
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
import logging

# 환경 변수에서 데이터베이스 URL 가져오기
DATABASE_URL = os.getenv('DATABASE_URL', 'postgresql://forte:forte123@localhost:5432/forte_db')

# 로깅 설정
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def get_db_connection():
    """데이터베이스 연결 생성"""
    try:
        engine = create_engine(DATABASE_URL)
        return engine
    except Exception as e:
        logger.error(f"데이터베이터 연결 실패: {e}")
        return None

def update_remaining_procedures():
    """나머지 14개 시술 정보 업데이트"""
    engine = get_db_connection()
    if not engine:
        logger.error("데이터베이스 연결을 생성할 수 없습니다.")
        return False
    
    # 나머지 14개 시술의 상세 업데이트 데이터
    remaining_procedures = [
        {
            "procedure_number": 3,
            "korean_name": "엘란세",
            "side_effects": "【일반적(5-10%)】멍, 붓기, 일시적 통증, 압통, 홍반, 주사부위 경결【드문(<2%)】육아종 형성(용해제 없어 제거 어려움), 결절 형성, 비대칭【심각한(<0.1%)】혈관폐쇄로 인한 피부괴사, 감염으로 인한 농양, 알레르기 반응【특별주의】PCL/PDLLA 알레르기, 콜라겐 생성 과다로 인한 과교정",
            "precautions": "【절대금기】임신/수유, PCL/PDLLA 알레르기, 시술부위 활성감염, 자가면역질환【상대금기】켈로이드 체질(과도한 콜라겐 생성), 혈액응고 장애, 면역억제제 복용【특별주의】비가역적 시술(용해제 없음), 과교정 시 2-4년간 지속, 콜라겐 생성 완료까지 6개월 소요【시술 후】마사지 금지, 과도한 표정변화 피하기, 염증 예방을 위한 항생제 복용 고려"
        },
        {
            "procedure_number": 5,
            "korean_name": "실피엄 X",
            "side_effects": "【일반적(20-30%)】3-4일간 지속적 붓기, 홍조, 따끔거림, 각질 탈락【중등도(5-10%)】색소침착(갈색반점), 좁쌀여드름 유사 반응, 접촉성 피부염【드문(<2%)】화상, 흉터 형성, 감염, 모낭염 악화【특별주의】금속 알레르기 환자 주의, RF 에너지로 인한 예상보다 깊은 열손상 가능",
            "precautions": "【절대금기】임신/수유, 심박동기 착용, 시술부위 금속 임플란트, 급성 피부질환【상대금기】켈로이드 체질, 금속 알레르기, 여드름 염증 활성기, 색소침착 경향【특별주의】니들 깊이 조절 실패 시 흉터 위험, 에너지 과다 시 화상 위험【시술 후】3일간 화장 금지, 1주일간 사우나/찜질방 금지, 색소침착 방지를 위한 미백관리 필수"
        },
        {
            "procedure_number": 6,
            "korean_name": "오리지오",
            "side_effects": "【일반적(15-25%)】시술 후 즉시 홍조, 온열감, 미세붓기【드문(1-3%)】일시적 색소침착, 화상, 접촉성 피부염【매우 드문(<0.5%)】흉터 형성, 비대칭적 탄력 변화【특별주의】RF 에너지 특성상 내부 열손상은 외부 손상보다 심할 수 있음",
            "precautions": "【절대금기】임신/수유, 심박동기 착용, 시술부위 금속 임플란트, 피부암 또는 의심 병변【상대금기】켈로이드 체질, 광과민성 약물 복용, 자가면역질환【특별주의】온도 조절 실패 시 심부 화상 위험, 즉각적 효과보다 점진적 개선【시술 후】24시간 뜨거운 물 금지, 1주일간 사우나 금지, 충분한 보습 및 자외선 차단 필수"
        },
        {
            "procedure_number": 8,
            "korean_name": "울쎄라",
            "side_effects": "【일반적(40-60%)】극심한 통증(마취 필수), 2-7일간 지속되는 심한 붓기, 멍【중등도(10-20%)】일시적 신경마비(안면신경 손상), 감각이상, 비대칭【드문(2-5%)】영구적 신경손상, 지방층 손실로 인한 함몰, 화상【심각한(<1%)】안면신경마비(영구적), 피부괴사, 청력 손상",
            "precautions": "【절대금기】임신/수유, 시술부위 금속 임플란트, 신경계 질환, 피부암【상대금기】켈로이드 체질, 혈액응고 장애, 심한 당뇨【고위험】안면신경 주행경로 근처 시술 시 영구마비 위험, HIFU 에너지 특성상 깊은 층 화상 가능【시술 후】2-3일 냉찜질, 1주일간 뜨거운 물/사우나 금지, 신경 증상 발생 시 즉시 병원 내원"
        },
        {
            "procedure_number": 9,
            "korean_name": "티타늄 리프팅",
            "side_effects": "【일반적(20-30%)】시술 후 즉시 홍조, 따뜻한 느낌, 미세 붓기【드문(2-5%)】색소침착, 일시적 감각저하, 접촉성 피부염【매우 드문(<1%)】화상, 흉터 형성【특별주의】복합 에너지(HIFU+RF) 사용으로 예상보다 강한 반응 가능",
            "precautions": "【절대금기】임신/수유, 심박동기 착용, 시술부위 금속 임플란트【상대금기】켈로이드 체질, 광과민성 약물 복용, 색소침착 경향【특별주의】다중 에너지 동시 적용으로 과도한 열손상 위험【시술 후】당일 화장 가능하지만 자극 최소화, 1주일간 고온 환경 피하기, 보습 및 자외선 차단 철저"
        },
        {
            "procedure_number": 11,
            "korean_name": "실 리프팅",
            "side_effects": "【일반적(30-40%)】2-5일간 지속되는 붓기와 멍, 당김감, 비대칭感【중등도(10-15%)】실 돌출/이물감, 감염, 염증성 육아종【심각한(3-5%)】실 이동/변형, 안면신경 손상, 피부 함몰, 영구적 비대칭【특별주의】실 종류별 부작용 차이, 시술자 숙련도에 따른 결과 편차 큼",
            "precautions": "【절대금기】시술부위 활성감염, 혈액응고 장애, 켈로이드 체질【상대금기】항응고제 복용, 면역억제제 복용, 흡연【특별주의】실 삽입 깊이/방향 오류 시 신경손상 위험, 과도한 당김 시 피부 손상【시술 후】1주일간 과도한 표정변화 금지, 마사지/압박 절대 금지, 실밥 돌출 시 임의 제거 금지, 감염 징후 시 즉시 병원 내원"
        },
        {
            "procedure_number": 12,
            "korean_name": "엑소좀 치료",
            "side_effects": "【일반적(10-20%)】주사부위 멍, 붓기, 일시적 홍조【드문(1-3%)】알레르기 반응(두드러기, 가려움), 주사부위 결절【심각한(<0.5%)】아나필락시스(생명위험), 감염, 자가면역반응 유발【특별주의】제품 표준화 부족으로 품질 편차 심함, 장기 안전성 데이터 부족",
            "precautions": "【절대금기】임신/수유, 자가면역질환, 면역억제제 복용, 활성 감염【상대금기】알레르기 체질, 혈액응고 장애【특별주의】엑소좀 출처/제조과정 불분명한 제품 위험, 과면역반응 가능성【시술 후】24시간 알레르기 반응 관찰, 이상 증상 시 즉시 병원 내원, 면역반응 억제를 위한 항히스타민제 준비"
        },
        {
            "procedure_number": 13,
            "korean_name": "바이오니클",
            "side_effects": "【일반적(40-50%)】2-4주간 심한 붓기, 통증, 멍, 압통, 경결【중등도(15-25%)】감각저하, 피부 괴사 위험, 비대칭, 과도한 지방분해【심각한(3-7%)】영구적 함몰, 피부괴사, 신경손상, 감염【생명위험】아나필락시스, 디옥시콜산 중독",
            "precautions": "【절대금기】임신/수유, 디옥시콜산 알레르기, 시술부위 감염, 혈액응고 장애【절대주의】목 부위 시술 시 성대신경 손상 위험, 과다 주입 시 영구적 함몰【특별주의】FDA 승인이지만 부작용 발생률 높음, 시술자 숙련도 매우 중요【시술 후】2-4주간 마사지 필수, 염증 관리, 함몰 방지를 위한 정기 검진"
        },
        {
            "procedure_number": 14,
            "korean_name": "투스컬프",
            "side_effects": "【일반적(25-35%)】시술 후 발적, 부종, 압통, 따뜻한 느낌【드문(3-8%)】화상, 색소침착, 지방괴사, 피부 함몰【매우 드문(<2%)】신경손상, 근육 손상【특별주의】MonoPolar RF 특성상 깊은 층까지 에너지 전달되어 내부손상 가능",
            "precautions": "【절대금기】임신/수유, 심박동기 착용, 시술부위 금속 임플란트【상대금기】켈로이드 체질, 당뇨, 혈액순환 장애【특별주의】대용량 지방분해로 인한 전신 반응 가능, 과도한 에너지 시 깊은 화상 위험【시술 후】충분한 수분섭취(하루 3L 이상), 1주일간 고강도 운동 금지, 정기적 림프마사지 권장"
        },
        {
            "procedure_number": 15,
            "korean_name": "포테자 재생 주사",
            "side_effects": "【일반적(15-25%)】니들 시술로 인한 점상 출혈, 붓기, 홍조【드문(2-5%)】색소침착, 접촉성 피부염, 모낭염【매우 드문(<1%)】흉터 형성, 감염【특별주의】마이크로니들 RF 조합으로 일반 니들보다 깊은 손상 가능",
            "precautions": "【절대금기】임신/수유, 시술부위 활성감염, 혈액응고 장애【상대금기】켈로이드 체질, 면역억제제 복용【특별주의】니들 깊이 조절 중요, RF 에너지 과다 시 흉터 위험【시술 후】24시간 화장 금지, 3일간 수영/사우나 금지, 재생 촉진을 위한 충분한 수면과 영양 섭취"
        },
        {
            "procedure_number": 16,
            "korean_name": "수광 주사",
            "side_effects": "【일반적(5-15%)】주사부위 일시적 따끔거림, 미세 멍【드문(1-3%)】알레르기 반응(비타민 C, 글루타치온), 주사부위 결절【매우 드문(<0.5%)】과민반응, 색소침착【특별주의】성분별 알레르기 반응 다름, 과도한 비타민 C 주입 시 결석 위험",
            "precautions": "【절대금기】비타민 C/글루타치온/히알루론산 알레르기, 임신/수유【상대금기】신장질환(비타민 C 과다), 혈액응고 장애【특별주의】개인별 맞춤 조성 필요, 과다 주입 금지【시술 후】충분한 수분섭취, 자외선 차단, 정기적 관리로 효과 지속"
        },
        {
            "procedure_number": 17,
            "korean_name": "물광 주사",
            "side_effects": "【일반적(10-20%)】마이크로니들로 인한 점상 출혈, 붓기, 따끔거림【드문(2-5%)】접촉성 피부염, 색소침착, 모낭염【매우 드문(<1%)】감염, 알레르기 반응【특별주의】니들 오염으로 인한 감염 위험, 장비 위생관리 중요",
            "precautions": "【절대금기】시술부위 활성감염, 혈액응고 장애, 면역저하【상대금기】켈로이드 체질, 민감성 피부【특별주의】일회용 니들 사용 확인, 멸균된 환경에서 시술【시술 후】24시간 화장 금지, 3일간 수영장/사우나 금지, 보습 관리 철저"
        },
        {
            "procedure_number": 18,
            "korean_name": "3D 하이픈",
            "side_effects": "【일반적(30-40%)】시술 후 붓기, 홍조, 따뜻한 느낌【중등도(10-15%)】일시적 신경감각 저하, 멍, 압통【드문(2-5%)】화상, 색소침착, 비대칭【매우 드문(<1%)】신경손상, 지방층 손실, 피부괴사",
            "precautions": "【절대금기】임신/수유, 시술부위 금속 임플란트, 피부암【상대금기】켈로이드 체질, 신경계 질환【특별주의】HIFU 에너지 특성상 깊은 층 손상 가능, 울쎄라 대비 상대적으로 안전하지만 주의 필요【시술 후】2-3일 냉찜질, 1주일간 고온 환경 피하기, 신경 증상 발생 시 병원 내원"
        },
        {
            "procedure_number": 19,
            "korean_name": "산소 관리",
            "side_effects": "【일반적】거의 없음, 매우 안전【드문(1% 미만)】일시적 어지러움(고압산소), 폐쇄공포증【매우 드문】산소 중독(장시간 노출 시)【특별주의】호흡기 질환자는 의료진 감독 하에 시술",
            "precautions": "【절대금기】기흉(자연기흉) 병력, 중증 COPD【상대금기】상기도 감염, 발열 상태【특별주의】매우 안전한 시술이지만 호흡기 상태 확인 필요【시술 후】특별한 주의사항 없음, 일상생활 즉시 가능"
        }
    ]
    
    try:
        with engine.begin() as conn:
            for procedure in remaining_procedures:
                query = text("""
                    UPDATE procedures 
                    SET side_effects = :side_effects,
                        precautions = :precautions,
                        last_updated = CURRENT_TIMESTAMP,
                        version = version + 1
                    WHERE procedure_number = :procedure_number
                """)
                
                result = conn.execute(query, {
                    'side_effects': procedure['side_effects'],
                    'precautions': procedure['precautions'],
                    'procedure_number': procedure['procedure_number']
                })
                
                if result.rowcount > 0:
                    logger.info(f"시술 #{procedure['procedure_number']} {procedure['korean_name']} 업데이트 완료")
                else:
                    logger.warning(f"시술 #{procedure['procedure_number']} {procedure['korean_name']} 업데이트 실패 - 해당 시술을 찾을 수 없음")
            
            logger.info("나머지 14개 시술 정보 업데이트가 완료되었습니다.")
            return True
            
    except Exception as e:
        logger.error(f"시술 정보 업데이트 실패: {e}")
        return False

def main():
    """메인 함수"""
    logger.info("=== 나머지 14개 시술 2025년 최신 연구 기반 업데이트 시작 ===")
    
    success = update_remaining_procedures()
    
    if success:
        logger.info("업데이트가 성공적으로 완료되었습니다!")
        logger.info("업데이트된 시술: 엘란세, 실피엄X, 오리지오, 울쎄라, 티타늄리프팅, 실리프팅, 엑소좀치료, 바이오니클, 투스컬프, 포테자재생, 수광주사, 물광주사, 3D하이픈, 산소관리")
        logger.info("주요 개선사항:")
        logger.info("- 2023-2025 최신 임상 데이터 및 연구 결과 반영")
        logger.info("- 부작용 발생률 및 심각도 분류 세분화")
        logger.info("- 환자 상태별 맞춤 금기사항 강화") 
        logger.info("- 응급상황 대처 방안 구체화")
        logger.info("- 시술별 특수 위험요소 명시")
        logger.info("- 전체 19개 시술이 동일한 상세도로 통일")
    else:
        logger.error("업데이트 중 오류가 발생했습니다.")
        sys.exit(1)

if __name__ == "__main__":
    main()